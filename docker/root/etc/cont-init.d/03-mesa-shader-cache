#!/usr/bin/with-contenv bash
set -euo pipefail

PUID="${PUID:-99}"
PGID="${PGID:-100}"

# Always ensure the "default" HOME cache path exists
HOME_CACHE="/home/Tdarr/.cache/mesa_shader_cache"

# Also ensure the configured cache path exists (if provided)
ENV_CACHE="${MESA_SHADER_CACHE_DIR:-}"

make_cache_dir() {
  local d="$1"
  local parent
  parent="$(dirname "$d")"

  mkdir -p "$d"

  # Make parent + dir writable by runtime user.
  # Non-recursive: avoid expensive chown on large caches every start.
  chown "$PUID:$PGID" "$parent" "$d"
  chmod 775 "$parent" "$d"
}

make_cache_dir "$HOME_CACHE"

# If MESA_SHADER_CACHE_DIR is set and points somewhere else, create that too
if [ -n "$ENV_CACHE" ] && [ "$ENV_CACHE" != "$HOME_CACHE" ]; then
  make_cache_dir "$ENV_CACHE"
fi
